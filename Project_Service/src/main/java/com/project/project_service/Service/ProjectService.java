package com.project.project_service.Service;

import com.project.project_service.DTO.*;
import com.project.project_service.Entity.Client;
import com.project.project_service.Entity.Entreprise;
import com.project.project_service.Entity.GitHubLink;
import com.project.project_service.Entity.Projet;
import com.project.project_service.Enumeration.PhaseProjet;
import com.project.project_service.Enumeration.PriorityProjet;
import com.project.project_service.Enumeration.StatusProjet;
import com.project.project_service.Repository.ClientRepository;
import com.project.project_service.Repository.GitHubLinkRepository;
import com.project.project_service.Repository.ProjetRepository;
import com.project.project_service.config.AuthClient;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDate;
import java.util.*;
import java.util.stream.Collectors;

@Service
public class ProjectService {
    @Autowired
    private ClientRepository clientRepository;

    @Autowired
    private ProjetRepository projectRepository;
    @Autowired
    private AuthClient authClient; // Inject the Feign clien
    @Autowired
    private GitHubLinkRepository gitHubLinkRepository;
    @Transactional
    public void createProject(String authId, String name, String description,
                              LocalDate startDate, LocalDate deadline,
                              String status, String phase, String priority) {
        // R√©cup√©rer le manager √† partir de l'authId
        Client manager = clientRepository.findByAuthId(authId);
        if (manager == null) {
            throw new RuntimeException("Manager non trouv√©");
        }

        // R√©cup√©rer l'entreprise associ√©e au manager
        Entreprise company = manager.getCompany();
        if (company == null) {
            throw new RuntimeException("Aucune entreprise associ√©e au manager");
        }

        // Cr√©er le projet
        Projet project = new Projet();
        project.setName(name);
        project.setDescription(description);
        project.setCompany(company); // Lier le projet √† l'entreprise
        project.setManager(manager); // Lier le manager au projet
        project.setCreationDate(LocalDate.now()); // Ajouter la date de cr√©ation
        project.setStartDate(startDate);
        project.setDeadline(deadline);
        project.setStatus(StatusProjet.valueOf(status)); // Convertir le String en Enum
        project.setPhase(PhaseProjet.valueOf(phase));    // Convertir le String en Enum
        project.setPriority(PriorityProjet.valueOf(priority));  // Convertir le String en Enum

        projectRepository.save(project);

        System.out.println("Projet cr√©√© avec succ√®s : " + project.getName());
    }


    @Transactional
    public void updateProject(String authId, String oldName, String newName,
                              String description, LocalDate startDate,
                              LocalDate deadline, String status,
                              String phase, String priority) {
        // R√©cup√©rer le manager √† partir de l'authId
        Client manager = clientRepository.findByAuthId(authId);
        if (manager == null) {
            throw new RuntimeException("Manager non trouv√©");
        }

        // R√©cup√©rer l'entreprise associ√©e au manager
        Entreprise company = manager.getCompany();
        if (company == null) {
            throw new RuntimeException("Aucune entreprise associ√©e au manager");
        }

        // R√©cup√©rer le projet √† modifier
        Projet project = projectRepository.findByNameAndCompany(oldName, company);
        if (project == null) {
            throw new RuntimeException("Projet non trouv√© ou vous n'avez pas les droits pour le modifier");
        }

        // Mettre √† jour les champs du projet
        project.setName(newName);
        project.setDescription(description);
        project.setStartDate(startDate);
        project.setDeadline(deadline);
        project.setStatus(StatusProjet.valueOf(status)); // Convertir le String en Enum
        project.setPhase(PhaseProjet.valueOf(phase));    // Convertir le String en Enum
        project.setPriority(PriorityProjet.valueOf(priority));  // Convertir le String en Enum

        // Optionnel : Tu peux ajouter des mises √† jour suppl√©mentaires si n√©cessaire, par exemple, le manager
        project.setManager(manager);

        projectRepository.save(project);

        System.out.println("Projet modifi√© avec succ√®s : " + project.getName());
    }

    @Transactional
    public void deleteProject(String authId, String name) {
        // R√©cup√©rer le manager √† partir de l'authId
        Client manager = clientRepository.findByAuthId(authId);
        if (manager == null) {
            throw new RuntimeException("Manager non trouv√©");
        }

        // R√©cup√©rer l'entreprise associ√©e au manager
        Entreprise company = manager.getCompany();
        if (company == null) {
            throw new RuntimeException("Aucune entreprise associ√©e au manager");
        }

        // R√©cup√©rer le projet √† supprimer
        Projet project = projectRepository.findByNameAndCompany(name, company);
        if (project == null) {
            throw new RuntimeException("Projet non trouv√© ou vous n'avez pas les droits pour le supprimer");
        }

        // Supprimer le projet
        projectRepository.delete(project);

        System.out.println("Projet supprim√© avec succ√®s : " + name);
    }

    // Nouvelle m√©thode pour r√©cup√©rer un projet par ID
    public Projet getProjectById(Long projectId) {
        return projectRepository.findById(projectId)
                .orElseThrow(() -> new RuntimeException("Projet non trouv√© avec l'ID : " + projectId));
    }

    // In ProjectService (Project Microservice)
    public Map<String, Object> getManagerByProject(String accessToken, Long projectId) {
        // R√©cup√©rer le projet pour obtenir le manager_id
        Projet project = projectRepository.findById(projectId)
                .orElseThrow(() -> new RuntimeException("Projet non trouv√© avec l'ID: " + projectId));
        System.out.println("‚úÖ Projet trouv√©: " + project.getName());

        Client manager = project.getManager();
        if (manager == null) {
            System.out.println("‚ùå Aucun manager associ√© au projet: " + projectId);
            return null; // Return null instead of throwing an exception
        }
        System.out.println("‚úÖ Manager trouv√©: " + manager.getId());

        // R√©cup√©rer l'authId du manager
        String managerAuthId = manager.getAuthId();
        if (managerAuthId == null) {
            System.out.println("‚ùå authId manquant pour le manager: " + manager.getId());
            return null; // Return null instead of throwing an exception
        }

        // Appeler le microservice Authentication via Feign pour r√©cup√©rer les d√©tails du manager
        try {
            Map<String, Object> userInfo = authClient.getUserDetailsByAuthId(
                    managerAuthId,
                    "Bearer " + accessToken
            );

            if (userInfo == null) {
                System.out.println("‚ö†Ô∏è Manager non trouv√© via le microservice Authentication : " + managerAuthId);
                return null;
            }

            // Construire un objet JSON pour le manager
            Map<String, Object> managerInfo = new HashMap<>();
            managerInfo.put("id", manager.getId().toString());
            managerInfo.put("authId", managerAuthId); // Include the authId
            managerInfo.put("firstName", userInfo.get("firstName"));
            managerInfo.put("lastName", userInfo.get("lastName"));
            managerInfo.put("role", manager.getRole() != null ? manager.getRole() : "Manager");
            managerInfo.put("avatar", userInfo.get("avatar"));

            return managerInfo;
        } catch (Exception e) {
            System.out.println("‚ùå Erreur lors de la r√©cup√©ration du manager " +
                    managerAuthId + " depuis le microservice Authentication : " + e.getMessage());
            return null;
        }
    }
    public ProjectDTO getProjectDetails(Long projectId, String accessToken) {
        Projet project = projectRepository.findById(projectId)
                .orElseThrow(() -> new RuntimeException("Projet non trouv√© avec l'ID: " + projectId));

        ManagerDTO managerDTO = null;
        Map<String, Object> managerInfo = getManagerByProject(accessToken, projectId);
        if (managerInfo != null) {
            managerDTO = new ManagerDTO(
                    Long.valueOf((String) managerInfo.get("id")),
                    (String) managerInfo.get("authId"),
                    (String) managerInfo.get("firstName"),
                    (String) managerInfo.get("lastName"),
                    (String) managerInfo.get("role")
            );
        }

        return new ProjectDTO(
                project.getId(),
                project.getName(),
                project.getDescription(),
                managerDTO,
                project.getCreationDate(),
                project.getStartDate(),
                project.getDeadline(),
                project.getStatus() != null ? project.getStatus().toString() : null,
                project.getPhase() != null ? project.getPhase().toString() : null,
                project.getPriority() != null ? project.getPriority().toString() : null
        );
    }


    public ProjectResponseWithRoleDTO getProjectsByUser(String authId) {
        try {
            System.out.println("üîç R√©cup√©ration des projets pour l'utilisateur avec authId: " + authId);

            // √âtape 1 : V√©rifier si l'utilisateur est un manager
            Client manager = clientRepository.findByAuthId(authId);
            Entreprise company = null;
            List<Projet> managerProjects = new ArrayList<>();

            if (manager != null) {
                company = manager.getCompany();
                if (company != null) {
                    managerProjects = projectRepository.findByCompany(company);
                    System.out.println("‚úÖ Projets du manager trouv√©s: " + managerProjects.size());
                } else {
                    System.out.println("‚ùå Aucune entreprise associ√©e au manager: " + authId);
                }
            } else {
                System.out.println("‚ùå Manager non trouv√© pour l'authId: " + authId);
            }

            // √âtape 2 : R√©cup√©rer les projets o√π l'utilisateur est membre via Authentification
            List<ProjectMemberDTO> projectMembers = authClient.getProjectMembersByUserId(authId);
            List<Projet> memberProjects = new ArrayList<>();
            Map<Long, String> roleMap = projectMembers.stream()
                    .collect(Collectors.toMap(ProjectMemberDTO::getProjectId, ProjectMemberDTO::getRoleInProject));
            System.out.println("üîç roleMap cr√©√©: " + roleMap);

            if (!projectMembers.isEmpty()) {
                List<Long> projectIds = projectMembers.stream()
                        .map(ProjectMemberDTO::getProjectId)
                        .collect(Collectors.toList());
                memberProjects = projectRepository.findAllById(projectIds);
                System.out.println("‚úÖ Projets du membre trouv√©s: " + memberProjects.size());
            } else {
                System.out.println("‚ÑπÔ∏è Aucun projet trouv√© pour le membre avec authId: " + authId);
            }

            // √âtape 3 : Combiner les projets (manager + membre) et √©viter les doublons
            Set<Projet> allProjects = new HashSet<>();
            allProjects.addAll(managerProjects);
            allProjects.addAll(memberProjects);
            System.out.println("üîç Projets combin√©s (allProjects): " + allProjects.size() +
                    ", IDs: " + allProjects.stream().map(p -> p.getId().toString()).collect(Collectors.joining(", ")));

            // √âtape 4 : Convertir les projets en DTO avec r√¥le
            List<ProjectWithRoleDTO> projectDTOs = allProjects.stream()
                    .map(project -> {
                        String role = roleMap.getOrDefault(project.getId(), "Manager");
                        System.out.println("üîç Projet ID: " + project.getId() + ", Nom: " + project.getName() +
                                ", R√¥le attribu√©: " + role);
                        return new ProjectWithRoleDTO(
                                project.getId(),
                                project.getName(),
                                project.getDescription(),
                                role,
                                project.getCreationDate().atStartOfDay(),
                                project.getStartDate().atStartOfDay(),
                                project.getDeadline().atStartOfDay(),
                                project.getStatus().name(),
                                project.getPhase().name(),
                                project.getPriority().name()
                        );
                    })
                    .collect(Collectors.toList());

            // √âtape 5 : Construire la r√©ponse
            String companyName = (company != null) ? company.getName() : "N/A";
            System.out.println("‚úÖ Projets totaux trouv√©s: " + projectDTOs.size());
            return new ProjectResponseWithRoleDTO(companyName, projectDTOs);
        } catch (Exception e) {
            System.err.println("‚ùå Erreur dans getProjectsByUser pour authId: " + authId +
                    ", Message: " + e.getMessage());
            e.printStackTrace();
            throw new RuntimeException("Erreur lors de la r√©cup√©ration des projets: " + e.getMessage());
        }
    }

    @Transactional
    public void linkGitHubRepositoryToProject(Long projectId, String repositoryUrl) {
        Projet project = projectRepository.findById(projectId)
                .orElseThrow(() -> new RuntimeException("Projet non trouv√© avec l'ID: " + projectId));

        GitHubLink existingLink = gitHubLinkRepository.findByProjetId(projectId);
        if (existingLink != null) {
            existingLink.setRepositoryUrl(repositoryUrl);
            gitHubLinkRepository.save(existingLink);
            System.out.println("üîÑ Lien GitHub mis √† jour : " + repositoryUrl);
        } else {
            GitHubLink link = new GitHubLink(repositoryUrl, project);
            gitHubLinkRepository.save(link);
            System.out.println("üîó D√©p√¥t GitHub li√© au projet : " + repositoryUrl);
        }
    }
    public String getGitHubRepositoryUrl(Long projectId) {
        GitHubLink link = gitHubLinkRepository.findByProjetId(projectId);
        return (link != null) ? link.getRepositoryUrl() : null;
    }

}
